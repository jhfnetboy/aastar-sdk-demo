<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AAStar SDK Demo - å¢å¼ºç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #eee;
            min-height: 100vh;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* å·¦ä¾§å¯¼èˆªæ  */
        .sidebar {
            width: 320px;
            background: rgba(22, 33, 62, 0.95);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px;
            overflow-y: auto;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .step {
            background: rgba(15, 76, 117, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .step:hover {
            background: rgba(15, 76, 117, 0.3);
            border-color: #3282b8;
        }

        .step.active {
            background: linear-gradient(135deg, #0f4c75 0%, #3282b8 100%);
            border-color: #3282b8;
        }

        .step.completed {
            border-color: #4ade80;
        }

        .step-header {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .step-icon {
            font-size: 24px;
        }

        .step-title {
            font-weight: 600;
            flex: 1;
        }

        .step-status {
            font-size: 18px;
        }

        /* å³ä¾§å†…å®¹åŒº */
        .content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .content-header {
            margin-bottom: 30px;
        }

        .content-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .content-subtitle {
            opacity: 0.7;
            font-size: 1.1rem;
        }

        /* å¡ç‰‡æ ·å¼ */
        .card {
            background: rgba(22, 33, 62, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* è¡¨æ ¼æ ·å¼ */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        th {
            background: rgba(15, 76, 117, 0.3);
            font-weight: 600;
            color: #3282b8;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #0f4c75 0%, #3282b8 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover:not(:disabled) {
            transform: scale(1.02);
            box-shadow: 0 4px 16px rgba(50, 130, 184, 0.5);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-success {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        /* å¾½ç« æ ·å¼ */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge-success {
            background: rgba(74, 222, 128, 0.2);
            color: #4ade80;
        }

        .badge-warning {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .badge-info {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        .badge-eoa {
            background: rgba(139, 92, 246, 0.2);
            color: #a78bfa;
        }

        .badge-aa {
            background: rgba(236, 72, 153, 0.2);
            color: #f472b6;
            border: 1px solid rgba(236, 72, 153, 0.3);
        }

        /* çŠ¶æ€å¡ç‰‡æ ·å¼ */
        .status-card {
            background: rgba(15, 76, 117, 0.2);
            border: 1px solid #3282b8;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            display: grid;
            gap: 10px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-label {
            opacity: 0.7;
            font-size: 0.9rem;
        }

        .status-value {
            font-weight: 600;
        }

        /* è¿è¥å•†ç±»å‹é€‰æ‹© */
        .type-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .type-option {
            background: rgba(22, 33, 62, 0.6);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .type-option:hover {
            border-color: rgba(50, 130, 184, 0.5);
        }

        .type-option.selected {
            border-color: #3282b8;
            background: rgba(50, 130, 184, 0.2);
        }

        .type-icon {
            font-size: 2rem;
            margin-bottom: 10px;
            display: block;
        }

        .type-name {
            font-weight: 700;
            display: block;
            margin-bottom: 5px;
        }

        .type-desc {
            font-size: 0.8rem;
            opacity: 0.6;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: #3282b8;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* éšè—ç±» */
        .hidden {
            display: none;
        }

        /* çŠ¶æ€ä¿¡æ¯æ¡† */
        .status-box {
            background: rgba(15, 76, 117, 0.2);
            border-left: 4px solid #3282b8;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .status-box.success {
            background: rgba(74, 222, 128, 0.1);
            border-left-color: #4ade80;
        }

        .status-box.error {
            background: rgba(239, 68, 68, 0.1);
            border-left-color: #ef4444;
        }

        /* Toast æç¤º */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(22, 33, 62, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 15px 20px;
            min-width: 300px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        .toast.success {
            border-left: 4px solid #4ade80;
        }

        .toast.error {
            border-left: 4px solid #ef4444;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* è¡¨å•æ ·å¼ */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #3282b8;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 10px 15px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #eee;
            font-size: 1rem;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #3282b8;
        }

        /* åˆ—è¡¨å¡ç‰‡ */
        .list-card {
            background: rgba(15, 76, 117, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
        }

        .list-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .list-card-title {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .list-card-detail {
            font-size: 0.9rem;
            opacity: 0.8;
            margin: 5px 0;
        }

        .modal {
            display: none; 
            position: fixed; 
            z-index: 2000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.8); 
        }

        .modal-content {
            background-color: #1a1a2e;
            margin: 10% auto; 
            padding: 20px; 
            border: 1px solid #888;
            width: 80%; 
            max-width: 800px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: white;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å·¦ä¾§æ­¥éª¤å¯¼èˆª -->
        <div class="sidebar">
            <div class="logo">ğŸš€ AAStar Demo</div>
            
            <div class="step" onclick="switchStep(0)">
                <div class="step-header">
                    <span class="step-icon">ğŸ </span>
                    <span class="step-title">My Dashboard (æˆ‘çš„)</span>
                    <span class="step-status"></span>
                </div>
            </div>

            <div class="step active" onclick="switchStep(1)">
                <div class="step-header">
                    <span class="step-icon">ğŸ‘¥</span>
                    <span class="step-title">è´¦æˆ·ç®¡ç†</span>
                    <span class="step-status" id="step1-status">â³</span>
                </div>
            </div>

            <div class="step" onclick="switchStep(2)">
                <div class="step-header">
                    <span class="step-icon">ğŸ›ï¸</span>
                    <span class="step-title">å¯åŠ¨ç¤¾åŒº</span>
                    <span class="step-status" id="step2-status">â³</span>
                </div>
            </div>

            <div class="step" onclick="switchStep(3)">
                <div class="step-header">
                    <span class="step-icon">âš™ï¸</span>
                    <span class="step-title">è¿è¥å•†</span>
                    <span class="step-status" id="step3-status">â³</span>
                </div>
            </div>

            <div class="step" onclick="switchStep(4)">
                <div class="step-header">
                    <span class="step-icon">ğŸ‘¤</span>
                    <span class="step-title">ç”¨æˆ·å…¥é©»</span>
                    <span class="step-status" id="step4-status">â³</span>
                </div>
            </div>

            <div class="step" onclick="showMetadata()" style="margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
                <div class="step-header">
                    <span class="step-icon">â„¹ï¸</span>
                    <span class="step-title">ç³»ç»Ÿä¿¡æ¯</span>
                </div>
            </div>
        </div>
        
        <!-- Metadata Modal -->
        <div id="metadata-modal" class="modal hidden">
            <div class="modal-content">
                <span class="close" onclick="closeMetadata()">&times;</span>
                <h2 style="margin-top:0">ğŸ›  ç³»ç»Ÿé…ç½®ä¿¡æ¯ (Metadata)</h2>
                <div id="metadata-content" class="code-box" style="max-height: 500px; overflow-y: auto;">
                    <span class="loading"></span> åŠ è½½ä¸­...
                </div>
            </div>
        </div>

        <!-- å³ä¾§å†…å®¹åŒº -->
        <div class="content">
            <!-- Global Context Header -->
             <div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span class="text-gray-400 text-sm">Context Admin:</span>
                    <select id="global-admin-select" class="form-select" style="width: 200px; padding: 5px 10px; font-size: 0.9rem;" onchange="loadMyDashboard()">
                        <option value="" disabled selected>Select Admin...</option>
                    </select>
                    <div class="text-sm text-gray-400 ml-4">
                        Server: <span class="text-green-400">â— Online</span>
                    </div>
                </div>
            </div>

            <!-- Global Data Storage -->
            <script>
                window.networkData = { v4: [], super: [] };
                window.accounts = [];
            </script>

            <!-- Step 0: My Dashboard (æˆ‘çš„) -->
            <div id="step0-content" class="hidden">
                <div class="content-header">
                    <h1 class="content-title">ğŸ  My Dashboard</h1>
                    <p class="content-subtitle">Manage your registered Communities, Tokens, and Paymasters.</p>
                </div>

                <!-- My Communities Section -->
                <div class="card">
                    <div class="card-title">ğŸ›ï¸ My Communities & Tokens</div>
                    <div id="my-communities-list">
                        <span class="text-gray-400">Please select a Context Admin to view data.</span>
                    </div>
                </div>

                <!-- My Paymasters Section -->
                <div class="card">
                    <div class="card-title">âš™ï¸ My Paymasters</div>
                    <div id="my-paymasters-list">
                        <span class="text-gray-400">Please select a Context Admin to view data.</span>
                    </div>
                </div>
            </div>

            <!-- Step 1: è´¦æˆ·ç®¡ç† -->
            <div id="step1-content">
                <div class="content-header">
                    <h1 class="content-title">ğŸ‘¥ è´¦æˆ·ç®¡ç†</h1>
                    <p class="content-subtitle">æŸ¥çœ‹å’Œç®¡ç†æ¼”ç¤ºè´¦æˆ·ï¼Œæ£€æŸ¥ä½™é¢çŠ¶æ€</p>
                </div>

                <div class="card">
                    <div class="card-title">
                        ğŸ“Š è´¦æˆ·åˆ—è¡¨
                        <button class="btn btn-success btn-small" style="margin-left: auto;" onclick="addNewAccount('EOA')">+ EOA è´¦æˆ·</button>
                        <button class="btn btn-small" onclick="addNewAccount('AA')">+ AA è´¦æˆ·</button>
                        <button class="btn btn-small" onclick="refreshBalances()">ğŸ”„ åˆ·æ–°</button>
                    </div>
                    
                    <table id="accounts-table">
                        <thead>
                            <tr>
                                <th>åç§°</th>
                                <th>ç±»å‹</th>
                                <th>åœ°å€</th>
                                <th>ETH</th>
                                <th>GToken</th>
                                <th>aPNTs</th>
                            </tr>
                        </thead>
                        <tbody id="accounts-tbody">
                            <tr>
                                <td colspan="6" style="text-align: center; opacity: 0.5;">
                                    <span class="loading"></span> åŠ è½½ä¸­...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="card">
                    <div class="card-title">ğŸ’° æ‰¹é‡å……å€¼</div>
                    <button class="btn" onclick="fundAllAccounts()">ä¸ºæ‰€æœ‰è´¦æˆ·å……å€¼</button>
                </div>
            </div>

            <!-- Step 2: å¯åŠ¨ç¤¾åŒº -->
            <div id="step2-content" class="hidden">
                <div class="content-header">
                    <h1 class="content-title">ğŸ›ï¸ å¯åŠ¨ç¤¾åŒº</h1>
                    <p class="content-subtitle">æ³¨å†Œç¤¾åŒºè§’è‰²å¹¶éƒ¨ç½²ç¤¾åŒº Token</p>
                </div>

                <div class="card">
                    <div class="card-title">ğŸ“‹ å·²æœ‰ç¤¾åŒº</div>
                    <div id="communities-list">
                        <span class="loading"></span> åŠ è½½ä¸­...
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">ğŸš€ å¯åŠ¨æ–°ç¤¾åŒº</div>
                    
                    <div class="form-group">
                        <label class="form-label">é€‰æ‹©ç®¡ç†å‘˜è´¦æˆ·</label>
                        <select class="form-select" id="community-account-select" onchange="checkStatus('community')">
                            <option value="">è¯·é€‰æ‹©è´¦æˆ·...</option>
                        </select>
                    </div>

                    <!-- ç¤¾åŒºçŠ¶æ€å¡ç‰‡ -->
                    <div id="community-status-box" class="hidden">
                        <div class="status-card">
                            <div class="status-item">
                                <span class="status-label">è§’è‰²çŠ¶æ€</span>
                                <span class="status-value" id="status-community-role">â³ æ£€æŸ¥ä¸­...</span>
                            </div>
                            <div id="community-info-details" class="hidden">
                                <div class="status-item">
                                    <span class="status-label">ç¤¾åŒº Token</span>
                                    <span class="status-value" id="status-community-token">--</span>
                                </div>
                                <div class="status-item">
                                    <span class="status-label">ç¤¾åŒºåç§°</span>
                                    <span class="status-value" id="status-community-name">--</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="launch-form">
                        <div class="form-group">
                            <label class="form-label">ç¤¾åŒºåç§°</label>
                            <input type="text" class="form-input" id="community-name" value="DemoDAO" />
                        </div>
                        <button class="btn" id="launch-btn" onclick="launchCommunity()">å¯åŠ¨ç¤¾åŒº</button>
                    </div>
                </div>
            </div>

            <!-- Step 3: è¿è¥å•† -->
            <div id="step3-content" class="hidden">
                <div class="content-header">
                    <h1 class="content-title">âš™ï¸ è¿è¥å•†ç®¡ç†</h1>
                    <p class="content-subtitle">æŸ¥çœ‹å·²æ³¨å†Œè¿è¥å•†æˆ–éƒ¨å±æ–°è¿è¥å•†</p>
                </div>

                <!-- Section A: Registered Operators -->
                <div class="card">
                    <div class="card-title">ğŸ“‹ å·²æ³¨å†Œè¿è¥å•† (Registered)</div>
                    <div id="operators-list">
                        <span class="loading"></span> åŠ è½½ä¸­...
                    </div>
                </div>

                <!-- Section B: Deploy New Operator -->
                <div class="card" style="margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <div class="card-title">ğŸš€ éƒ¨ç½²/æ³¨å†Œæ–°è¿è¥å•† (Deploy New)</div>
                    <p class="text-sm text-gray-400 mb-4">
                        Current Context Admin: <span id="deploy-context-admin" class="text-white font-bold">Select Admin above</span>
                    </p>

                    <div id="setup-form">
                        <div class="form-label">é€‰æ‹©è¿è¥å•†ç±»å‹</div>
                        <div class="type-selector">
                            <div class="type-option selected" id="type-super" onclick="selectOperatorType('super')">
                                <span class="type-icon">âš¡</span>
                                <span class="type-name">SuperPaymaster</span>
                                <span class="type-desc">è·¨ç¤¾åŒºå…±äº«ï¼Œæ”¯æŒå¤šå¸ç§</span>
                            </div>
                            <div class="type-option" id="type-v4" onclick="selectOperatorType('v4')">
                                <span class="type-icon">ğŸ“¦</span>
                                <span class="type-name">Paymaster V4</span>
                                <span class="type-desc">ç¤¾åŒºç‹¬ç«‹éƒ¨ç½²ï¼Œå•å¸ç§</span>
                            </div>
                        </div>
                        <button class="btn" id="setup-btn" onclick="setupOperator()">å¼€å§‹è®¾ç½® (For Context Admin)</button>
                    </div>
                </div>
            </div>

            <!-- Step 4: ç”¨æˆ·å…¥é©» -->
            <div id="step4-content" class="hidden">
                <div class="content-header">
                    <h1 class="content-title">ğŸ‘¤ ç”¨æˆ·å…¥é©»</h1>
                    <p class="content-subtitle">éƒ¨ç½² AA è´¦æˆ·å¹¶ Mint SBT</p>
                </div>

                <div class="card">
                    <div class="card-title">ğŸ¯ ç”¨æˆ·å…¥é©»æµç¨‹</div>
                    
                    <div class="form-group">
                        <label class="form-label">é€‰æ‹©ç”¨æˆ·è´¦æˆ· (EOA)</label>
                        <select class="form-select" id="user-account-select" onchange="checkStatus('user')">
                            <option value="">è¯·é€‰æ‹©è´¦æˆ·...</option>
                        </select>
                    </div>

                    <div id="user-status-box" class="hidden">
                        <div class="status-card">
                            <div class="status-item">
                                <span class="status-label">è´¦æˆ·çŠ¶æ€</span>
                                <span class="status-value" id="status-user-aa">â³ æ£€æŸ¥ä¸­...</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">SBT çŠ¶æ€</span>
                                <span class="status-value" id="status-user-sbt">æœªæŒæœ‰</span>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">é€‰æ‹©ç¤¾åŒº</label>
                        <select class="form-select" id="onboard-community-select">
                            <option value="">è¯·é€‰æ‹©ç¤¾åŒº...</option>
                        </select>
                    </div>

                    <div class="btn-group" style="display: flex; gap: 10px;">
                        <button class="btn" id="onboard-btn" onclick="onboardUser()">éƒ¨ç½² AA å¹¶ Mint SBT</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';
        let currentStep = 1;
        let accountsData = [];
        let balancesData = [];
        let communitiesData = [];
        let operatorsData = [];
        let selectedOperatorType = 'super';

        // é€‰æ‹©è¿è¥å•†ç±»å‹
        function selectOperatorType(type) {
            selectedOperatorType = type;
            document.getElementById('type-super').classList.toggle('selected', type === 'super');
            document.getElementById('type-v4').classList.toggle('selected', type === 'v4');
        }

        // æ£€æŸ¥è´¦æˆ·çŠ¶æ€ (Step 2/3/4 è‡ªåŠ¨è§¦å‘)
        async function checkStatus(step) {
            const selectId = {
                'community': 'community-account-select',
                'operator': 'operator-account-select',
                'user': 'user-account-select'
            }[step];
            
            const accountIdx = document.getElementById(selectId).value;
            if (!accountIdx) {
                document.getElementById(`${step}-status-box`).classList.add('hidden');
                return;
            }

            const account = accountsData[accountIdx];
            const statusBox = document.getElementById(`${step}-status-box`);
            statusBox.classList.remove('hidden');

            try {
                if (step === 'community') {
                    const roleLabel = document.getElementById('status-community-role');
                    const detailsDiv = document.getElementById('community-info-details');
                    const launchBtn = document.getElementById('launch-btn');
                    roleLabel.innerHTML = '<span class="loading"></span> æ£€æŸ¥ä¸­...';
                    
                    const response = await fetch(`${API_BASE}/get-communities`, { method: 'POST' });
                    const result = await response.json();
                    if (result.success) {
                        const info = result.communities.find(c => c.accountAddress.toLowerCase() === account.address.toLowerCase());
                        if (info && info.hasRole) {
                            roleLabel.innerHTML = 'âœ… å·²æ³¨å†Œ';
                            detailsDiv.classList.remove('hidden');
                            document.getElementById('status-community-token').textContent = info.tokenAddress.slice(0, 10) + '...';
                            document.getElementById('status-community-name').textContent = info.communityData?.name || 'DemoDAO';
                            launchBtn.textContent = 'é‡æ–°å¯åŠ¨/æ›´æ–°';
                        } else {
                            roleLabel.innerHTML = 'âŒ æœªæ³¨å†Œ';
                            detailsDiv.classList.add('hidden');
                            launchBtn.textContent = 'å¯åŠ¨ç¤¾åŒº';
                        }
                    }
                } else if (step === 'operator') {
                    const typeLabel = document.getElementById('status-operator-type');
                    const detailsDiv = document.getElementById('operator-details');
                    const setupBtn = document.getElementById('setup-btn');
                    typeLabel.innerHTML = '<span class="loading"></span> æ£€æŸ¥ä¸­...';

                    const response = await fetch(`${API_BASE}/get-operators`, { method: 'POST' });
                    const result = await response.json();
                    if (result.success) {
                        const info = result.operators.find(o => o.accountAddress.toLowerCase() === account.address.toLowerCase());
                        if (info && info.type) {
                            typeLabel.innerHTML = `âœ… ${info.type === 'super' ? 'SuperPaymaster' : 'Paymaster V4'}`;
                            detailsDiv.classList.remove('hidden');
                            const balance = info.superPaymaster?.balance || info.paymasterV4?.balance || 0;
                            document.getElementById('status-operator-balance').textContent = (Number(balance) / 1e18).toFixed(2);
                            document.getElementById('status-operator-config').textContent = info.superPaymaster?.isConfigured ? 'âœ… å·²é…ç½®' : 'âš ï¸ æœªé…ç½®';
                            setupBtn.textContent = 'é‡æ–°é…ç½®';
                        } else {
                            typeLabel.innerHTML = 'âŒ æœªæ³¨å†Œ';
                            detailsDiv.classList.add('hidden');
                            setupBtn.textContent = 'å¼€å§‹è®¾ç½®';
                        }
                    }
                } else if (step === 'user') {
                    const aaLabel = document.getElementById('status-user-aa');
                    const sbtLabel = document.getElementById('status-user-sbt');
                    aaLabel.innerHTML = '<span class="loading"></span> æ£€æŸ¥ä¸­...';
                    
                    // è¿™é‡Œå¯ä»¥æ·»åŠ æ£€æŸ¥ AA æ˜¯å¦éƒ¨ç½²çš„é€»è¾‘
                    aaLabel.textContent = account.type === 'AA' ? 'âœ… å·²åˆ›å»º(è®¡ç®—åœ°å€)' : 'âŒ å°šæœªåˆ›å»º';
                    sbtLabel.textContent = 'æ£€æŸ¥ä¸­...';
                    
                    const response = await fetch(`${API_BASE}/get-communities`, { method: 'POST' });
                    const result = await response.json();
                    // è¿™é‡Œç®€åŒ–é€»è¾‘ï¼šæ£€æŸ¥è¯¥ EOA æ˜¯å¦åœ¨æŸç¤¾åŒºæœ‰ SBT (å®é™…ä¸Šåº”è¯¥æ£€æŸ¥å…¶ AA åœ°å€)
                    sbtLabel.textContent = 'æœªæŒæœ‰';
                }
            } catch (error) {
                console.error('æ£€æŸ¥çŠ¶æ€å¤±è´¥:', error);
            }
        }

        // Toast æç¤º
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // åˆ‡æ¢æ­¥éª¤
        async function switchStep(step) {
            document.querySelectorAll('.step').forEach((el, idx) => {
                // Step 0 is 'My Dashboard', Step 1 is index 1, etc.
                // My logic: switchStep(0) -> index 0. switchStep(1) -> index 1.
                // Sidebar items are: [0: My, 1: Accounts, 2: Community, 3: Operator, 4: User]
                // So index matches step if step=0..4
                if (idx === step) el.classList.add('active');
                else el.classList.remove('active');
            });
            
            // Content divs
            [0, 1, 2, 3, 4].forEach(i => {
                const el = document.getElementById(`step${i}-content`);
                if(el) {
                    if (i === step) el.classList.remove('hidden');
                    else el.classList.add('hidden');
                }
            });

            if (step === 0) await loadMyDashboard();
            if (step === 1) await loadAccounts();
            if (step === 2) await loadCommunities();
            if (step === 3) await loadOperators();
        }

        async function loadMyDashboard() {
            const adminAddr = document.getElementById('global-admin-select').value;
            const comDiv = document.getElementById('my-communities-list');
            const pmDiv = document.getElementById('my-paymasters-list');
            const deployAdminSpan = document.getElementById('deploy-context-admin');

            if (deployAdminSpan) {
                deployAdminSpan.textContent = adminAddr ? (
                    (accountsData.find(a=>a.address===adminAddr)?.name || 'Unknown') + ` (${adminAddr.slice(0,6)}...)`
                ) : 'Select Admin above';
            }

            if (!adminAddr) {
                 comDiv.innerHTML = '<span class="text-gray-400">Please select a Context Admin first.</span>';
                 pmDiv.innerHTML = '<span class="text-gray-400">Please select a Context Admin first.</span>';
                 return;
            }

            // 1. My Communities & Tokens
            // We need communities data. If not loaded, fetch it.
            if (!window.networkData || !window.networkData.communities) {
                 await loadCommunities(true); // silent load
            }
            const myComs = (window.networkData.communities || []).filter(c => c.accountAddress.toLowerCase() === adminAddr.toLowerCase());
            
            if (myComs.length === 0) {
                 comDiv.innerHTML = '<div class="text-gray-500 italic">No communities found for this admin.</div>';
            } else {
                 comDiv.innerHTML = myComs.map(c => {
                     const hasToken = c.tokenAddress && c.tokenAddress !== '0x0000000000000000000000000000000000000000';
                     const registered = c.isRegistered; // from API
                     return `
                        <div class="list-card">
                            <div class="list-card-title">${c.communityData?.name || 'Unknown Community'}</div>
                            <div class="list-card-detail text-xs text-gray-400">${c.address}</div>
                            <div class="mt-2 text-sm">
                                <div class="flex justify-between">
                                    <span>Registry Status:</span>
                                    <span class="${registered ? 'text-green-400' : 'text-red-400'}">${registered ? 'âœ… Registered' : 'âŒ Not Registered'}</span>
                                </div>
                                <div class="flex justify-between mt-1">
                                    <span>xPNTs Token:</span>
                                    <span class="${hasToken ? 'text-green-400' : 'text-red-400'}">${hasToken ? 'âœ… Deployed' : 'âŒ Not Deployed'}</span>
                                </div>
                            </div>
                            ${!hasToken ? `<button onclick="deployToken('${c.accountAddress}', '${c.communityData?.name || 'Community'}')" class="mt-2 bg-blue-900 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs w-full">Deploy xPNTs</button>` : ''}
                        </div>
                     `;
                 }).join('');
            }

            // 2. My Paymasters
            if (!window.networkData || !window.networkData.v4) {
                 await loadOperators(true);
            }
            // Filter V4 Paymasters where operator == adminAddr
            // And also check SuperPaymaster (if they are one)
            const myV4 = (window.networkData.v4 || []).filter(p => p.operator.toLowerCase() === adminAddr.toLowerCase());
            const mySuper = (window.networkData.super || []).filter(p => p.address.toLowerCase() === adminAddr.toLowerCase()); // Super uses address as identity usually
            
            let pmHtml = '';
            
            // V4 Paymasters
            if (myV4.length > 0) {
                pmHtml += myV4.map(p => `
                    <div class="list-card">
                        <div class="list-card-title">ğŸ“¦ Paymaster V4</div>
                        <div class="list-card-detail text-xs text-gray-400">${p.address}</div>
                         <div class="mt-2 text-sm">
                             <div class="flex justify-between">
                                <span>Version:</span>
                                <span>${p.version}</span>
                             </div>
                             <div class="flex justify-between mt-1">
                                 <span>Supported Tokens:</span>
                                 <span>${(p.supportedTokens||[]).length}</span>
                             </div>
                        </div>
                        <!-- Binding Logic: Check against My Communities -->
                        ${myComs.map(c => {
                             if (!c.tokenAddress || c.tokenAddress === '0x0000000000000000000000000000000000000000') return '';
                             // Check if this Paymaster supports this token
                             const isBound = (p.supportedTokens || []).map(t=>t.toLowerCase()).includes(c.tokenAddress.toLowerCase());
                             if (isBound) {
                                 return `<div class="mt-2 text-xs text-green-400 border border-green-900 bg-green-900/20 p-1 rounded text-center">âœ… Bound to ${c.communityData?.name}</div>`;
                             } else {
                                 return `<button onclick="bindPaymaster('${c.tokenAddress}', '${c.accountAddress}')" class="mt-2 bg-purple-900 hover:bg-purple-700 text-white px-2 py-1 rounded text-xs w-full">Bind to ${c.communityData?.name}</button>`;
                             }
                        }).join('')}
                    </div>
                `).join('');
            }

            if (mySuper.length > 0) {
                 pmHtml += mySuper.map(p => `
                    <div class="list-card border-yellow-700/50">
                        <div class="list-card-title text-yellow-500">âš¡ SuperPaymaster Operator</div>
                         <div class="mt-2 text-xs text-center text-gray-400">
                            (Universal Access)
                        </div>
                    </div>
                 `).join('');
            }

            if (pmHtml === '') {
                 pmHtml = '<div class="text-gray-500 italic">No Paymasters found for this admin.</div>';
            }
            
            pmDiv.innerHTML = pmHtml;
        }

        async function loadCommunities(silent = false) {
            try {
                const res = await (await fetch(`${API_BASE}/get-communities`, { method: 'POST' })).json();
                if (res.success) {
                    if (!window.networkData) window.networkData = {};
                    window.networkData.communities = res.communities; // Cache for Dashboard
                    
                    if (!silent) {
                        const listDiv = document.getElementById('communities-list');
                        if (listDiv) { // Only update if element exists (Step 2 might be hidden)
                            renderCommunitiesList(res.communities);
                        }
                        populateAccountSelect('community-account-select');
                    }
                }
            } catch (e) { console.error(e); if (!silent) showToast('åŠ è½½ç¤¾åŒºå¤±è´¥', 'error'); }
        }

        function renderCommunitiesList(accounts) {
             const listDiv = document.getElementById('communities-list');
             if(!listDiv) return;
             if (accounts.length === 0) {
                 listDiv.innerHTML = '<div class="text-center text-gray-500 py-4">æš‚æ— ç¤¾åŒº</div>';
                 return;
             }
             listDiv.innerHTML = accounts.map(c => {
                        const adminDisplay = `
                            <div class="code-box break-all text-xs" style="margin-top:2px;">
                                <a href="https://sepolia.etherscan.io/address/${c.accountAddress}" target="_blank" style="color: white; text-decoration: underline;">
                                    ${c.accountAddress}
                                </a>
                                ${c.accountName && c.accountName !== 'Unknown Community' ? `<br/><span class="text-gray-500">(${c.accountName})</span>` : ''}
                            </div>
                        `;
                        
                        return `
                        <div class="list-card">
                            <div class="list-card-header">
                                <span class="list-card-title">ğŸ›ï¸ ${c.communityData?.name || 'Community'}</span>
                                <span class="badge ${c.hasRole ? 'badge-success' : 'badge-aa'}">${c.hasRole ? 'å·²æ¿€æ´»' : 'å¾…é…ç½®'}</span>
                            </div>
                            <div class="list-card-detail">
                                <span class="text-gray-600 font-bold">Operator (Admin):</span>
                                ${adminDisplay}
                            </div>
                            <div class="list-card-detail mt-2">
                                ${c.tokenAddress && c.tokenAddress != '0x0000000000000000000000000000000000000000'
                                    ? `<div class="text-green-400">Token: ${c.tokenAddress.slice(0,10)}...</div>`
                                    : `<div class="text-red-400">Token: Not Deployed</div>
                                       <button onclick="deployToken('${c.accountAddress}', '${c.communityData?.name || 'Community'}')" class="mt-1 bg-blue-900 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs" style="width:100%">Deploy xPNTs</button>`
                                }
                            </div>
                        </div>
                    `}).join('');
        }

        // å¡«å……è´¦æˆ·é€‰æ‹©å™¨
        function populateAccountSelect(selectId) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">è¯·é€‰æ‹©è´¦æˆ·...</option>' +
                accountsData.map((acc, idx) => `<option value="${idx}">${acc.name} (${acc.address.slice(0, 10)}...)</option>`).join('');
        }

        // åŠ è½½è´¦æˆ·åˆ—è¡¨
        async function loadAccounts() {
            try {
                let response = await fetch(`${API_BASE}/state`);
                let result = await response.json();
                if (!result.accounts || result.accounts.length === 0) {
                    response = await fetch(`${API_BASE}/generate-accounts`, { method: 'POST' });
                    result = await response.json();
                }
                if (result.success || result.accounts) {
                    accountsData = result.accounts;
                    
                    // Populate Global Admin Select
                    const globalSelect = document.getElementById('global-admin-select');
                    globalSelect.innerHTML = accountsData.map(a => 
                        `<option value="${a.address}">${a.name} (${a.address.slice(0,6)}...)</option>`
                    ).join('');
                    if(accountsData.length > 0) globalSelect.value = accountsData[0].address;

                    renderAccountsTable();
                    await refreshBalances();
                }
            } catch (error) {
                showToast('åŠ è½½è´¦æˆ·å¤±è´¥', 'error');
            }
        }

        // åˆ·æ–°ä½™é¢
        async function refreshBalances() {
            try {
                const response = await fetch(`${API_BASE}/get-balances`, { method: 'POST' });
                const result = await response.json();
                if (result.success) {
                    balancesData = result.balances;
                    renderAccountsTable();
                }
            } catch (error) {
                showToast('åˆ·æ–°ä½™é¢å¤±è´¥', 'error');
            }
        }

        // æ¸²æŸ“è´¦æˆ·è¡¨æ ¼
        function renderAccountsTable() {
            const tbody = document.getElementById('accounts-tbody');
            if (!accountsData.length) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; opacity: 0.5;">æš‚æ— è´¦æˆ·</td></tr>';
                return;
            }
            tbody.innerHTML = accountsData.map((account, idx) => {
                const balance = balancesData[idx] || { eth: '0', gToken: '0', aPNTs: '0' };
                const accountType = account.type || 'EOA';
                return `
                    <tr>
                        <td><strong>${account.name}</strong></td>
                        <td><span class="badge ${accountType === 'AA' ? 'badge-aa' : 'badge-eoa'}">${accountType}</span></td>
                        <td><code style="font-size: 0.85rem;">${account.address.slice(0, 10)}...${account.address.slice(-8)}</code></td>
                        <td>${(Number(balance.eth) / 1e18).toFixed(4)} ETH</td>
                        <td>${(Number(balance.gToken) / 1e18).toFixed(2)}</td>
                        <td>${(Number(balance.aPNTs) / 1e18).toFixed(2)}</td>
                    </tr>
                `;
            }).join('');
        }

        // åŠ¨ä½œå‡½æ•°
        async function addNewAccount(type) {
            try {
                const response = await fetch(`${API_BASE}/add-account`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ type }) });
                if ((await response.json()).success) { await loadAccounts(); showToast(`âœ… ${type} è´¦æˆ·åˆ›å»ºæˆåŠŸï¼`); }
            } catch (e) { showToast('åˆ›å»ºè´¦æˆ·å¤±è´¥', 'error'); }
        }

        async function fundAllAccounts() {
            try {
                const btn = event.target || document.querySelector('button[onclick="fundAllAccounts()"]');
                const originalText = btn.textContent;
                btn.disabled = true; 
                btn.innerHTML = '<span class="loading"></span> æ™ºèƒ½å……å€¼ä¸­(ETH/GToken/aPNTs)...';
                
                const response = await fetch(`${API_BASE}/fund-accounts`, { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ethAmount: '0.1', tokenAmount: '1000' }) 
                });
                const res = await response.json();
                
                if (res.success) {
                    await refreshBalances();
                    let msg = 'âœ… æ™ºèƒ½å……å€¼å®Œæˆï¼';
                    if (res.results) {
                        const mutations = res.results.filter(r => r.actions.some(a => !a.includes('OK')));
                        if (mutations.length > 0) {
                            msg += `<br/><span style="font-size:0.8em">${mutations.length} ä¸ªè´¦æˆ·å·²æ›´æ–°ä½™é¢</span>`;
                        } else {
                            msg += ' (æ‰€æœ‰è´¦æˆ·ä½™é¢å……è¶³)';
                        }
                    }
                    showToast(msg);
                } else {
                    showToast('å……å€¼å¼‚å¸¸: ' + (res.error || 'Unknown error'), 'error');
                }
                
                btn.disabled = false; 
                btn.textContent = originalText;
            } catch (e) { 
                console.error(e);
                showToast('å……å€¼è¯·æ±‚å¤±è´¥', 'error'); 
                const btn = event.target || document.querySelector('button[onclick="fundAllAccounts()"]');
                if(btn) { btn.disabled = false; btn.textContent = 'ä¸ºæ‰€æœ‰è´¦æˆ·å……å€¼'; }
            }
        }

        async function launchCommunity() {
            const idx = document.getElementById('community-account-select').value;
            if (!idx) return showToast('è¯·é€‰æ‹©è´¦æˆ·', 'error');
            try {
                const btn = event.target; btn.disabled = true; btn.innerHTML = '<span class="loading"></span> å¯åŠ¨ä¸­...';
                const res = await (await fetch(`${API_BASE}/launch-community`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ accountIndex: parseInt(idx), name: document.getElementById('community-name').value }) })).json();
                if (res.success) { await loadCommunities(); showToast('âœ… ç¤¾åŒºå¯åŠ¨æˆåŠŸï¼'); await checkStatus('community'); }
                else showToast('å¯åŠ¨å¤±è´¥: ' + res.error, 'error');
                btn.disabled = false; btn.textContent = 'å¯åŠ¨ç¤¾åŒº';
            } catch (e) { showToast('å¯åŠ¨å¤±è´¥', 'error'); event.target.disabled = false; }
        }



        async function setupOperator() {
            // Use Global Context Admin
            const adminAddr = document.getElementById('global-admin-select').value;
            if (!adminAddr) return showToast('Please select a Context Admin first (Top Right)', 'error');
            
            // Find account index (API expects index)
            const accountIndex = accountsData.findIndex(a => a.address.toLowerCase() === adminAddr.toLowerCase());
            if (accountIndex === -1) return showToast('Selected Admin not found in local accounts', 'error');

            try {
                const btn = event.target; 
                const originalText = btn.innerHTML;
                btn.disabled = true; btn.innerHTML = '<span class="loading"></span> Setting up...';
                
                const res = await (await fetch(`${API_BASE}/setup-operator`, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ accountIndex: accountIndex, type: selectedOperatorType }) 
                })).json();

                if (res.success) { 
                    await loadOperators(); 
                    showToast('âœ… Operator Setup/Deployed Successfully!'); 
                    // Refresh Dashboard too if needed
                    // await loadMyDashboard(); 
                } else {
                    showToast('Setup Failed: ' + res.error, 'error');
                }
                btn.disabled = false; btn.innerHTML = originalText;
            } catch (e) { showToast('Setup Request Failed', 'error'); event.target.disabled = false; }
        }

    async function deployToken(accountAddr, commName) {
        const name = prompt("Enter Token Name:", commName + " Token");
        if (!name) return;
        const symbol = prompt("Enter Token Symbol:", "XPNT");
        
        const btn = event.target; 
        const originalText = btn.innerText;
        btn.innerText = 'Deploying...'; btn.disabled = true;

        try {
            const res = await (await fetch(`${API_BASE}/deploy-token`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ accountAddress: accountAddr, name, symbol, communityName: commName })
            })).json();
            
            if (res.success) {
                showToast(`Token Deployed! Tx: ${res.tx} (Waiting confirm...)`);
                setTimeout(loadCommunities, 5000); // refresh later
            } else {
                showToast("Deploy Failed: " + res.error, "error");
            }
        } catch (e) { showToast(e.message, "error"); }
        btn.innerText = originalText; btn.disabled = false;
    }

    async function bindPaymaster(tokenAddr, communityOwnerAddr) {
        const adminAddr = document.getElementById('global-admin-select').value;
        if (!adminAddr) return showToast('Please select a Global Admin first', 'error');

        // Logic Check: Does Admin match Community Owner?
        if (communityOwnerAddr && adminAddr.toLowerCase() !== communityOwnerAddr.toLowerCase()) {
            if(!confirm(`âš ï¸ Warning: You are operating as ${adminAddr.slice(0,6)}... \nbut the community owner is ${communityOwnerAddr.slice(0,6)}... \n\nContinue anyway?`)) return;
        }

        // Find Paymasters owned by this Admin
        const myPaymasters = window.networkData.v4.filter(p => p.operator.toLowerCase() === adminAddr.toLowerCase());
        
        let targetPmAddr = null;
        if (myPaymasters.length === 0) {
            return showToast('Selected Admin has no V4 Paymasters deployed.', 'error');
        } else if (myPaymasters.length === 1) {
            targetPmAddr = myPaymasters[0].address;
            if(!confirm(`Bind Token to your Paymaster ${targetPmAddr.slice(0,6)}...?`)) return;
        } else {
            // Multiple paymasters, let them pick (simple prompt for now)
            const listStr = myPaymasters.map((p,i) => `[${i}] ${p.address.slice(0,6)}...`).join('\n');
            const idx = prompt(`You have ${myPaymasters.length} Paymasters. Enter index (0-${myPaymasters.length-1}):\n${listStr}`, "0");
            if (idx === null) return;
            if (myPaymasters[idx]) targetPmAddr = myPaymasters[idx].address;
            else return showToast('Invalid selection', 'error');
        }

        const btn = event.target; 
        const originalText = btn.innerText;
        btn.innerText = 'Binding...'; btn.disabled = true;

        try {
            const res = await (await fetch(`${API_BASE}/bind-paymaster`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ paymasterAddress: targetPmAddr, tokenAddress: tokenAddr, operatorAddress: adminAddr })
            })).json();
            
            if (res.success) {
                showToast(`Bound Successfully! Tx: ${res.tx}`);
                // Refresh to show status if possible (though binding is on PM side, won't change Community card much unless we track it)
            } else {
                showToast("Bind Failed: " + res.error, "error");
            }
        } catch (e) { showToast(e.message, "error"); }
        btn.innerText = originalText; btn.disabled = false;
    }

    async function loadOperators() {
            const listDiv = document.getElementById('operators-list');
            try {
                const res = await (await fetch(`${API_BASE}/get-network-operators`, { method: 'POST' })).json();
                if (res.success) {
                    window.networkData = { v4: res.v4, super: res.super }; // Store for binding logic

                    let html = '';

                    // 1. Factory Deployments (V4)
                    html += `<div style="margin-bottom: 20px;">
                        <h4 style="margin-bottom: 8px;">ğŸ— Factory Deployments (V4) <span class="badge" style="background:#eee;color:#333">${res.v4.length}</span></h4>
                        ${res.v4.length > 0 ? res.v4.map(o => `
                            <div class="list-card">
                                <div class="list-card-header">
                                    <span class="list-card-title">âš™ï¸ Paymaster (V4)</span>
                                    <span class="badge badge-success">Deployed</span>
                                </div>
                                <div class="list-card-detail">
                                    <span class="text-gray-600 font-bold">Paymaster Address:</span>
                                    <div class="code-box break-all text-xs" style="margin-top:2px;">
                                        <a href="https://sepolia.etherscan.io/address/${o.address}" target="_blank" style="color: white; text-decoration: underline;">${o.address}</a>
                                    </div>
                                </div>
                                <div class="list-card-detail mt-2">
                                    <span class="text-gray-600 font-bold">Operator:</span>
                                    <div class="code-box break-all text-xs" style="margin-top:2px;">
                                        <a href="https://sepolia.etherscan.io/address/${o.operator}" target="_blank" style="color: white; text-decoration: underline;">${o.operator}</a>
                                        ${o.operatorName ? `<br/><span class="text-gray-500">(${o.operatorName})</span>` : ''}
                                    </div>
                                </div>
                                <div class="list-card-detail mt-2">
                                    <span class="text-gray-600 font-bold">Supported Token (xPNTs):</span>
                                    <div style="margin-top:2px; font-family:monospace; color:#a8d1ff">
                                        ${o.tokens && o.tokens.length > 0 ? o.tokens.map(t => `<a href="https://sepolia.etherscan.io/address/${t}" target="_blank" style="color: inherit;">${t.slice(0,10)}...</a>`).join(', ') : '<span style="color:#f87171">Not Initialized / None</span>'}
                                    </div>
                                </div>
                            </div>
                        `).join('') : '<div class="text-gray-500 text-sm italic">æš‚æ— éƒ¨ç½²</div>'}
                    </div>`;

                    // 2. SuperPaymaster Operators
                    html += `<div>
                        <div class="flex justify-between items-center mb-2">
                            <h4 style="margin-bottom: 0;">ğŸ¦¸ SuperPaymaster Operators <span class="badge" style="background:#eee;color:#333">${res.super.length}</span></h4>
                            <div class="text-xs text-right">
                                <span class="text-gray-500">aPNTs Token:</span>
                                <a href="https://sepolia.etherscan.io/address/${res.constants?.apntsToken}" target="_blank" style="color: white; text-decoration: underline;">
                                    ${res.constants?.apntsToken?.slice(0, 8)}...${res.constants?.apntsToken?.slice(-6)}
                                </a>
                            </div>
                        </div>
                        ${res.super.length > 0 ? res.super.map(o => `
                            <div class="list-card">
                                <div class="list-card-header">
                                    <span class="list-card-title">âš¡ï¸ SuperPaymaster</span>
                                    <span class="badge badge-success">Registered</span>
                                </div>
                                <div class="list-card-detail">
                                    <span class="text-gray-600 font-bold">Operator (Admin):</span>
                                    <div class="code-box break-all text-xs" style="margin-top:2px;">
                                        <a href="https://sepolia.etherscan.io/address/${o.operator}" target="_blank" style="color: white; text-decoration: underline;">${o.operator}</a>
                                        ${o.operatorName ? `<br/><span class="text-gray-500">(${o.operatorName})</span>` : ''}
                                    </div>
                                </div>
                                <div class="list-card-detail mt-2">
                                    <span class="text-gray-600 font-bold">Deposit (Balance):</span>
                                    <span class="text-white font-mono">${(Number(o.balance || 0) / 1e18).toFixed(4)} aPNTs</span>
                                </div>
                                <div class="list-card-detail mt-2">
                                    <span class="text-gray-600 font-bold">Shared Contract:</span>
                                    <div class="code-box break-all text-xs" style="margin-top:2px;">
                                        <a href="https://sepolia.etherscan.io/address/${o.address}" target="_blank" style="color: white; text-decoration: underline;">${o.address}</a>
                                    </div>
                                </div>
                            </div>
                        `).join('') : '<div class="text-gray-500 text-sm italic">æš‚æ— æ³¨å†Œ</div>'}
                    </div>`;

                    listDiv.innerHTML = html;
                } else {
                    listDiv.innerHTML = 'åŠ è½½å¤±è´¥';
                }
            } catch (e) { listDiv.innerHTML = 'åŠ è½½å¤±è´¥'; }
        }

        async function onboardUser() {
            const idx = document.getElementById('user-account-select').value;
            const commAddr = document.getElementById('onboard-community-select').value;
            
            if (!idx) return showToast('è¯·é€‰æ‹©è´¦æˆ·', 'error');
            if (!commAddr) return showToast('è¯·é€‰æ‹©ç¤¾åŒº', 'error');

            try {
                const btn = document.getElementById('onboard-btn');
                btn.disabled = true; btn.innerHTML = '<span class="loading"></span> å¤„ç†ä¸­...';
                
                const res = await (await fetch(`${API_BASE}/onboard-user`, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ accountIndex: parseInt(idx), communityAddress: commAddr }) 
                })).json();

                if (res.success) { showToast('âœ… å…¥é©»æˆåŠŸï¼SBT ID: ' + res.sbtId); await checkStatus('user'); }
                else showToast('å…¥é©»å¤±è´¥: ' + res.error, 'error');
                btn.disabled = false; btn.textContent = 'éƒ¨ç½² AA å¹¶ Mint SBT';
            } catch (e) { showToast('å¤±è´¥', 'error'); document.getElementById('onboard-btn').disabled = false; }
        }

        async function populateCommunitySelect() {
            const select = document.getElementById('onboard-community-select');
            try {
                const res = await (await fetch(`${API_BASE}/get-communities`, { method: 'POST' })).json();
                if (res.success && res.communities.length > 0) {
                    // Start filtering valid communities
                    const validCommunities = res.communities.filter(c => c.hasRole);
                    if (validCommunities.length > 0) {
                        select.innerHTML = '<option value="">è¯·é€‰æ‹©ç¤¾åŒº...</option>' + 
                            validCommunities.map(c => `<option value="${c.accountAddress}">${c.communityData?.name || 'Unnamed'} (${c.accountAddress.slice(0,8)}...)</option>`).join('');
                    } else {
                        select.innerHTML = '<option value="">æš‚æ— å·²æ¿€æ´»ç¤¾åŒº</option>';
                    }
                } else {
                    select.innerHTML = '<option value="">æš‚æ— ç¤¾åŒº</option>';
                }
            } catch (e) { console.error(e); }
        }

        window.onload = async () => {
            await loadAccounts();
            await loadCommunities();
            await loadOperators();
        };

        async function showMetadata() {
            const modal = document.getElementById('metadata-modal');
            modal.style.display = 'block';
            modal.classList.remove('hidden');
            
            try {
                const res = await (await fetch(`${API_BASE}/config`)).json();
                if (res.success) {
                    const commsRes = await (await fetch(`${API_BASE}/get-communities`, { method: 'POST' })).json();
                    const communities = commsRes.success ? commsRes.communities : [];

                    document.getElementById('metadata-content').innerHTML = `
                        <div style="margin-bottom:10px"><strong>Network:</strong> ${res.network}</div>
                        <div style="margin-bottom:10px"><strong>Supplier (Admin):</strong> ${res.config.supplier}</div>
                        <hr style="border-color:#444;margin:10px 0"/>
                        <div style="margin-bottom:5px"><strong>Contracts:</strong></div>
                        <div class="code-box text-xs">Registry: ${res.config.contracts.registry}</div>
                        <div class="code-box text-xs mt-1">PaymasterFactory: ${res.config.contracts.paymasterFactory}</div>
                        <div class="code-box text-xs mt-1">SimpleAccountFactory: ${res.config.contracts.simpleAccountFactory}</div>
                        <div class="code-box text-xs mt-1">GToken: ${res.config.contracts.gToken}</div>
                        <div class="code-box text-xs mt-1" style="color:#a8d1ff">APNTs (Global): ${res.config.contracts.apntsToken || 'Not Set'}</div>
                        
                        <hr style="border-color:#444;margin:10px 0"/>
                        <div style="margin-bottom:5px"><strong>Community Tokens (X Points):</strong></div>
                        ${communities.length > 0 ? communities.map(c => `
                            <div style="margin-bottom:8px; padding-bottom:8px; border-bottom:1px solid #333">
                                <div style="font-weight:bold">${c.communityData?.name || 'Unknown'} <span style="font-size:0.8em;color:#888">(${c.accountAddress.slice(0,6)}...)</span></div>
                                <div style="font-size:0.85em; margin-top:2px">
                                    <span style="color:#aaa">Token:</span> 
                                    <span style="font-family:monospace; color:#a8d1ff">${c.tokenAddress || 'Not Configured'}</span>
                                </div>
                            </div>
                        `).join('') : '<div style="color:#888;font-style:italic">No communities found</div>'}

                        <div style="margin-top:20px; font-size:10px; color:#666">
                            RPC: ${res.config.rpcUrl}
                        </div>
                    `;
                }
            } catch (e) {
                document.getElementById('metadata-content').innerText = 'åŠ è½½å¤±è´¥';
            }
        }

        function closeMetadata() {
            document.getElementById('metadata-modal').style.display = 'none';
        }
    </script>
</body>
</html>
