<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AAStar SDK Demo - å¢å¼ºç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #eee;
            min-height: 100vh;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* å·¦ä¾§å¯¼èˆªæ  */
        .sidebar {
            width: 320px;
            background: rgba(22, 33, 62, 0.95);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px;
            overflow-y: auto;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .step {
            background: rgba(15, 76, 117, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .step:hover {
            background: rgba(15, 76, 117, 0.3);
            border-color: #3282b8;
        }

        .step.active {
            background: linear-gradient(135deg, #0f4c75 0%, #3282b8 100%);
            border-color: #3282b8;
        }

        .step.completed {
            border-color: #4ade80;
        }

        .step-header {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .step-icon {
            font-size: 24px;
        }

        .step-title {
            font-weight: 600;
            flex: 1;
        }

        .step-status {
            font-size: 18px;
        }

        /* å³ä¾§å†…å®¹åŒº */
        .content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .content-header {
            margin-bottom: 30px;
        }

        .content-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .content-subtitle {
            opacity: 0.7;
            font-size: 1.1rem;
        }

        /* å¡ç‰‡æ ·å¼ */
        .card {
            background: rgba(22, 33, 62, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* è¡¨æ ¼æ ·å¼ */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        th {
            background: rgba(15, 76, 117, 0.3);
            font-weight: 600;
            color: #3282b8;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #0f4c75 0%, #3282b8 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover:not(:disabled) {
            transform: scale(1.02);
            box-shadow: 0 4px 16px rgba(50, 130, 184, 0.5);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-success {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        /* å¾½ç« æ ·å¼ */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge-success {
            background: rgba(74, 222, 128, 0.2);
            color: #4ade80;
        }

        .badge-warning {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .badge-info {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        .badge-eoa {
            background: rgba(139, 92, 246, 0.2);
            color: #a78bfa;
        }

        .badge-aa {
            background: rgba(236, 72, 153, 0.2);
            color: #f472b6;
            border: 1px solid rgba(236, 72, 153, 0.3);
        }

        /* çŠ¶æ€å¡ç‰‡æ ·å¼ */
        .status-card {
            background: rgba(15, 76, 117, 0.2);
            border: 1px solid #3282b8;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            display: grid;
            gap: 10px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-label {
            opacity: 0.7;
            font-size: 0.9rem;
        }

        .status-value {
            font-weight: 600;
        }

        /* è¿è¥å•†ç±»å‹é€‰æ‹© */
        .type-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .type-option {
            background: rgba(22, 33, 62, 0.6);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .type-option:hover {
            border-color: rgba(50, 130, 184, 0.5);
        }

        .type-option.selected {
            border-color: #3282b8;
            background: rgba(50, 130, 184, 0.2);
        }

        .type-icon {
            font-size: 2rem;
            margin-bottom: 10px;
            display: block;
        }

        .type-name {
            font-weight: 700;
            display: block;
            margin-bottom: 5px;
        }

        .type-desc {
            font-size: 0.8rem;
            opacity: 0.6;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: #3282b8;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* éšè—ç±» */
        .hidden {
            display: none;
        }

        /* çŠ¶æ€ä¿¡æ¯æ¡† */
        .status-box {
            background: rgba(15, 76, 117, 0.2);
            border-left: 4px solid #3282b8;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .status-box.success {
            background: rgba(74, 222, 128, 0.1);
            border-left-color: #4ade80;
        }

        .status-box.error {
            background: rgba(239, 68, 68, 0.1);
            border-left-color: #ef4444;
        }

        /* Toast æç¤º */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(22, 33, 62, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 15px 20px;
            min-width: 300px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        .toast.success {
            border-left: 4px solid #4ade80;
        }

        .toast.error {
            border-left: 4px solid #ef4444;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* è¡¨å•æ ·å¼ */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #3282b8;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 10px 15px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #eee;
            font-size: 1rem;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #3282b8;
        }

        /* åˆ—è¡¨å¡ç‰‡ */
        .list-card {
            background: rgba(15, 76, 117, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
        }

        .list-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .list-card-title {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .list-card-detail {
            font-size: 0.9rem;
            opacity: 0.8;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å·¦ä¾§æ­¥éª¤å¯¼èˆª -->
        <div class="sidebar">
            <div class="logo">ğŸš€ AAStar Demo</div>
            
            <div class="step active" onclick="switchStep(1)">
                <div class="step-header">
                    <span class="step-icon">ğŸ‘¥</span>
                    <span class="step-title">è´¦æˆ·ç®¡ç†</span>
                    <span class="step-status" id="step1-status">â³</span>
                </div>
            </div>

            <div class="step" onclick="switchStep(2)">
                <div class="step-header">
                    <span class="step-icon">ğŸ›ï¸</span>
                    <span class="step-title">å¯åŠ¨ç¤¾åŒº</span>
                    <span class="step-status" id="step2-status">â³</span>
                </div>
            </div>

            <div class="step" onclick="switchStep(3)">
                <div class="step-header">
                    <span class="step-icon">âš™ï¸</span>
                    <span class="step-title">è¿è¥å•†è®¾ç½®</span>
                    <span class="step-status" id="step3-status">â³</span>
                </div>
            </div>

            <div class="step" onclick="switchStep(4)">
                <div class="step-header">
                    <span class="step-icon">ğŸ‘¤</span>
                    <span class="step-title">ç”¨æˆ·å…¥é©»</span>
                    <span class="step-status" id="step4-status">â³</span>
                </div>
            </div>
        </div>

        <!-- å³ä¾§å†…å®¹åŒº -->
        <div class="content">
            <!-- Step 1: è´¦æˆ·ç®¡ç† -->
            <div id="step1-content">
                <div class="content-header">
                    <h1 class="content-title">ğŸ‘¥ è´¦æˆ·ç®¡ç†</h1>
                    <p class="content-subtitle">æŸ¥çœ‹å’Œç®¡ç†æ¼”ç¤ºè´¦æˆ·ï¼Œæ£€æŸ¥ä½™é¢çŠ¶æ€</p>
                </div>

                <div class="card">
                    <div class="card-title">
                        ğŸ“Š è´¦æˆ·åˆ—è¡¨
                        <button class="btn btn-success btn-small" style="margin-left: auto;" onclick="addNewAccount('EOA')">+ EOA è´¦æˆ·</button>
                        <button class="btn btn-small" onclick="addNewAccount('AA')">+ AA è´¦æˆ·</button>
                        <button class="btn btn-small" onclick="refreshBalances()">ğŸ”„ åˆ·æ–°</button>
                    </div>
                    
                    <table id="accounts-table">
                        <thead>
                            <tr>
                                <th>åç§°</th>
                                <th>ç±»å‹</th>
                                <th>åœ°å€</th>
                                <th>ETH</th>
                                <th>GToken</th>
                                <th>aPNTs</th>
                            </tr>
                        </thead>
                        <tbody id="accounts-tbody">
                            <tr>
                                <td colspan="6" style="text-align: center; opacity: 0.5;">
                                    <span class="loading"></span> åŠ è½½ä¸­...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="card">
                    <div class="card-title">ğŸ’° æ‰¹é‡å……å€¼</div>
                    <button class="btn" onclick="fundAllAccounts()">ä¸ºæ‰€æœ‰è´¦æˆ·å……å€¼</button>
                </div>
            </div>

            <!-- Step 2: å¯åŠ¨ç¤¾åŒº -->
            <div id="step2-content" class="hidden">
                <div class="content-header">
                    <h1 class="content-title">ğŸ›ï¸ å¯åŠ¨ç¤¾åŒº</h1>
                    <p class="content-subtitle">æ³¨å†Œç¤¾åŒºè§’è‰²å¹¶éƒ¨ç½²ç¤¾åŒº Token</p>
                </div>

                <div class="card">
                    <div class="card-title">ğŸ“‹ å·²æœ‰ç¤¾åŒº</div>
                    <div id="communities-list">
                        <span class="loading"></span> åŠ è½½ä¸­...
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">ğŸš€ å¯åŠ¨æ–°ç¤¾åŒº</div>
                    
                    <div class="form-group">
                        <label class="form-label">é€‰æ‹©ç®¡ç†å‘˜è´¦æˆ·</label>
                        <select class="form-select" id="community-account-select" onchange="checkStatus('community')">
                            <option value="">è¯·é€‰æ‹©è´¦æˆ·...</option>
                        </select>
                    </div>

                    <!-- ç¤¾åŒºçŠ¶æ€å¡ç‰‡ -->
                    <div id="community-status-box" class="hidden">
                        <div class="status-card">
                            <div class="status-item">
                                <span class="status-label">è§’è‰²çŠ¶æ€</span>
                                <span class="status-value" id="status-community-role">â³ æ£€æŸ¥ä¸­...</span>
                            </div>
                            <div id="community-info-details" class="hidden">
                                <div class="status-item">
                                    <span class="status-label">ç¤¾åŒº Token</span>
                                    <span class="status-value" id="status-community-token">--</span>
                                </div>
                                <div class="status-item">
                                    <span class="status-label">ç¤¾åŒºåç§°</span>
                                    <span class="status-value" id="status-community-name">--</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="launch-form">
                        <div class="form-group">
                            <label class="form-label">ç¤¾åŒºåç§°</label>
                            <input type="text" class="form-input" id="community-name" value="DemoDAO" />
                        </div>
                        <button class="btn" id="launch-btn" onclick="launchCommunity()">å¯åŠ¨ç¤¾åŒº</button>
                    </div>
                </div>
            </div>

            <!-- Step 3: è¿è¥å•†è®¾ç½® -->
            <div id="step3-content" class="hidden">
                <div class="content-header">
                    <h1 class="content-title">âš™ï¸ è¿è¥å•†è®¾ç½®</h1>
                    <p class="content-subtitle">é…ç½® Paymaster è¿è¥å•†</p>
                </div>

                <div class="card">
                    <div class="card-title">ğŸ“‹ å·²æœ‰è¿è¥å•†</div>
                    <div id="operators-list">
                        <span class="loading"></span> åŠ è½½ä¸­...
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">ğŸ”§ è®¾ç½®æ–°è¿è¥å•†</div>
                    
                    <div class="form-group">
                        <label class="form-label">é€‰æ‹©æ“ä½œè´¦æˆ·</label>
                        <select class="form-select" id="operator-account-select" onchange="checkStatus('operator')">
                            <option value="">è¯·é€‰æ‹©è´¦æˆ·...</option>
                        </select>
                    </div>

                    <div id="operator-status-box" class="hidden">
                        <div class="status-card">
                            <div class="status-item">
                                <span class="status-label">è¿è¥å•†ç±»å‹</span>
                                <span class="status-value" id="status-operator-type">âŒ æœªæ³¨å†Œ</span>
                            </div>
                            <div id="operator-details" class="hidden">
                                <div class="status-item">
                                    <span class="status-label">aPNTs ä½™é¢</span>
                                    <span class="status-value" id="status-operator-balance">0.00</span>
                                </div>
                                <div class="status-item">
                                    <span class="status-label">é…ç½®çŠ¶æ€</span>
                                    <span class="status-value" id="status-operator-config">âš ï¸ æœªé…ç½®</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="setup-form">
                        <div class="form-label">é€‰æ‹©è¿è¥å•†ç±»å‹</div>
                        <div class="type-selector">
                            <div class="type-option selected" id="type-super" onclick="selectOperatorType('super')">
                                <span class="type-icon">âš¡</span>
                                <span class="type-name">SuperPaymaster</span>
                                <span class="type-desc">è·¨ç¤¾åŒºå…±äº«ï¼Œæ”¯æŒå¤šå¸ç§</span>
                            </div>
                            <div class="type-option" id="type-v4" onclick="selectOperatorType('v4')">
                                <span class="type-icon">ğŸ“¦</span>
                                <span class="type-name">Paymaster V4</span>
                                <span class="type-desc">ç¤¾åŒºç‹¬ç«‹éƒ¨ç½²ï¼Œå•å¸ç§</span>
                            </div>
                        </div>
                        <button class="btn" id="setup-btn" onclick="setupOperator()">å¼€å§‹è®¾ç½®</button>
                    </div>
                </div>
            </div>

            <!-- Step 4: ç”¨æˆ·å…¥é©» -->
            <div id="step4-content" class="hidden">
                <div class="content-header">
                    <h1 class="content-title">ğŸ‘¤ ç”¨æˆ·å…¥é©»</h1>
                    <p class="content-subtitle">éƒ¨ç½² AA è´¦æˆ·å¹¶ Mint SBT</p>
                </div>

                <div class="card">
                    <div class="card-title">ğŸ¯ ç”¨æˆ·å…¥é©»æµç¨‹</div>
                    
                    <div class="form-group">
                        <label class="form-label">é€‰æ‹©ç”¨æˆ·è´¦æˆ· (EOA)</label>
                        <select class="form-select" id="user-account-select" onchange="checkStatus('user')">
                            <option value="">è¯·é€‰æ‹©è´¦æˆ·...</option>
                        </select>
                    </div>

                    <div id="user-status-box" class="hidden">
                        <div class="status-card">
                            <div class="status-item">
                                <span class="status-label">è´¦æˆ·çŠ¶æ€</span>
                                <span class="status-value" id="status-user-aa">â³ æ£€æŸ¥ä¸­...</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">SBT çŠ¶æ€</span>
                                <span class="status-value" id="status-user-sbt">æœªæŒæœ‰</span>
                            </div>
                        </div>
                    </div>

                    <div class="btn-group" style="display: flex; gap: 10px;">
                        <button class="btn" id="onboard-btn" onclick="onboardUser()">éƒ¨ç½² AA å¹¶ Mint SBT</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';
        let currentStep = 1;
        let accountsData = [];
        let balancesData = [];
        let communitiesData = [];
        let operatorsData = [];
        let selectedOperatorType = 'super';

        // é€‰æ‹©è¿è¥å•†ç±»å‹
        function selectOperatorType(type) {
            selectedOperatorType = type;
            document.getElementById('type-super').classList.toggle('selected', type === 'super');
            document.getElementById('type-v4').classList.toggle('selected', type === 'v4');
        }

        // æ£€æŸ¥è´¦æˆ·çŠ¶æ€ (Step 2/3/4 è‡ªåŠ¨è§¦å‘)
        async function checkStatus(step) {
            const selectId = {
                'community': 'community-account-select',
                'operator': 'operator-account-select',
                'user': 'user-account-select'
            }[step];
            
            const accountIdx = document.getElementById(selectId).value;
            if (!accountIdx) {
                document.getElementById(`${step}-status-box`).classList.add('hidden');
                return;
            }

            const account = accountsData[accountIdx];
            const statusBox = document.getElementById(`${step}-status-box`);
            statusBox.classList.remove('hidden');

            try {
                if (step === 'community') {
                    const roleLabel = document.getElementById('status-community-role');
                    const detailsDiv = document.getElementById('community-info-details');
                    const launchBtn = document.getElementById('launch-btn');
                    roleLabel.innerHTML = '<span class="loading"></span> æ£€æŸ¥ä¸­...';
                    
                    const response = await fetch(`${API_BASE}/get-communities`, { method: 'POST' });
                    const result = await response.json();
                    if (result.success) {
                        const info = result.communities.find(c => c.accountAddress.toLowerCase() === account.address.toLowerCase());
                        if (info && info.hasRole) {
                            roleLabel.innerHTML = 'âœ… å·²æ³¨å†Œ';
                            detailsDiv.classList.remove('hidden');
                            document.getElementById('status-community-token').textContent = info.tokenAddress.slice(0, 10) + '...';
                            document.getElementById('status-community-name').textContent = info.communityData?.name || 'DemoDAO';
                            launchBtn.textContent = 'é‡æ–°å¯åŠ¨/æ›´æ–°';
                        } else {
                            roleLabel.innerHTML = 'âŒ æœªæ³¨å†Œ';
                            detailsDiv.classList.add('hidden');
                            launchBtn.textContent = 'å¯åŠ¨ç¤¾åŒº';
                        }
                    }
                } else if (step === 'operator') {
                    const typeLabel = document.getElementById('status-operator-type');
                    const detailsDiv = document.getElementById('operator-details');
                    const setupBtn = document.getElementById('setup-btn');
                    typeLabel.innerHTML = '<span class="loading"></span> æ£€æŸ¥ä¸­...';

                    const response = await fetch(`${API_BASE}/get-operators`, { method: 'POST' });
                    const result = await response.json();
                    if (result.success) {
                        const info = result.operators.find(o => o.accountAddress.toLowerCase() === account.address.toLowerCase());
                        if (info && info.type) {
                            typeLabel.innerHTML = `âœ… ${info.type === 'super' ? 'SuperPaymaster' : 'Paymaster V4'}`;
                            detailsDiv.classList.remove('hidden');
                            const balance = info.superPaymaster?.balance || info.paymasterV4?.balance || 0;
                            document.getElementById('status-operator-balance').textContent = (Number(balance) / 1e18).toFixed(2);
                            document.getElementById('status-operator-config').textContent = info.superPaymaster?.isConfigured ? 'âœ… å·²é…ç½®' : 'âš ï¸ æœªé…ç½®';
                            setupBtn.textContent = 'é‡æ–°é…ç½®';
                        } else {
                            typeLabel.innerHTML = 'âŒ æœªæ³¨å†Œ';
                            detailsDiv.classList.add('hidden');
                            setupBtn.textContent = 'å¼€å§‹è®¾ç½®';
                        }
                    }
                } else if (step === 'user') {
                    const aaLabel = document.getElementById('status-user-aa');
                    const sbtLabel = document.getElementById('status-user-sbt');
                    aaLabel.innerHTML = '<span class="loading"></span> æ£€æŸ¥ä¸­...';
                    
                    // è¿™é‡Œå¯ä»¥æ·»åŠ æ£€æŸ¥ AA æ˜¯å¦éƒ¨ç½²çš„é€»è¾‘
                    aaLabel.textContent = account.type === 'AA' ? 'âœ… å·²åˆ›å»º(è®¡ç®—åœ°å€)' : 'âŒ å°šæœªåˆ›å»º';
                    sbtLabel.textContent = 'æ£€æŸ¥ä¸­...';
                    
                    const response = await fetch(`${API_BASE}/get-communities`, { method: 'POST' });
                    const result = await response.json();
                    // è¿™é‡Œç®€åŒ–é€»è¾‘ï¼šæ£€æŸ¥è¯¥ EOA æ˜¯å¦åœ¨æŸç¤¾åŒºæœ‰ SBT (å®é™…ä¸Šåº”è¯¥æ£€æŸ¥å…¶ AA åœ°å€)
                    sbtLabel.textContent = 'æœªæŒæœ‰';
                }
            } catch (error) {
                console.error('æ£€æŸ¥çŠ¶æ€å¤±è´¥:', error);
            }
        }

        // Toast æç¤º
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // åˆ‡æ¢æ­¥éª¤
        function switchStep(step) {
            document.querySelectorAll('.step').forEach((el, idx) => el.classList.toggle('active', idx + 1 === step));
            for (let i = 1; i <= 4; i++) document.getElementById(`step${i}-content`).classList.add('hidden');
            document.getElementById(`step${step}-content`).classList.remove('hidden');
            currentStep = step;
            if (step === 1) loadAccounts();
            else if (step === 2) { loadCommunities(); populateAccountSelect('community-account-select'); }
            else if (step === 3) { loadOperators(); populateAccountSelect('operator-account-select'); }
            else if (step === 4) { populateAccountSelect('user-account-select'); }
        }

        // å¡«å……è´¦æˆ·é€‰æ‹©å™¨
        function populateAccountSelect(selectId) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">è¯·é€‰æ‹©è´¦æˆ·...</option>' +
                accountsData.map((acc, idx) => `<option value="${idx}">${acc.name} (${acc.address.slice(0, 10)}...)</option>`).join('');
        }

        // åŠ è½½è´¦æˆ·åˆ—è¡¨
        async function loadAccounts() {
            try {
                let response = await fetch(`${API_BASE}/state`);
                let result = await response.json();
                if (!result.accounts || result.accounts.length === 0) {
                    response = await fetch(`${API_BASE}/generate-accounts`, { method: 'POST' });
                    result = await response.json();
                }
                if (result.success || result.accounts) {
                    accountsData = result.accounts;
                    renderAccountsTable();
                    await refreshBalances();
                }
            } catch (error) {
                showToast('åŠ è½½è´¦æˆ·å¤±è´¥', 'error');
            }
        }

        // åˆ·æ–°ä½™é¢
        async function refreshBalances() {
            try {
                const response = await fetch(`${API_BASE}/get-balances`, { method: 'POST' });
                const result = await response.json();
                if (result.success) {
                    balancesData = result.balances;
                    renderAccountsTable();
                }
            } catch (error) {
                showToast('åˆ·æ–°ä½™é¢å¤±è´¥', 'error');
            }
        }

        // æ¸²æŸ“è´¦æˆ·è¡¨æ ¼
        function renderAccountsTable() {
            const tbody = document.getElementById('accounts-tbody');
            if (!accountsData.length) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; opacity: 0.5;">æš‚æ— è´¦æˆ·</td></tr>';
                return;
            }
            tbody.innerHTML = accountsData.map((account, idx) => {
                const balance = balancesData[idx] || { eth: '0', gToken: '0', aPNTs: '0' };
                const accountType = account.type || 'EOA';
                return `
                    <tr>
                        <td><strong>${account.name}</strong></td>
                        <td><span class="badge ${accountType === 'AA' ? 'badge-aa' : 'badge-eoa'}">${accountType}</span></td>
                        <td><code style="font-size: 0.85rem;">${account.address.slice(0, 10)}...${account.address.slice(-8)}</code></td>
                        <td>${(Number(balance.eth) / 1e18).toFixed(4)} ETH</td>
                        <td>${(Number(balance.gToken) / 1e18).toFixed(2)}</td>
                        <td>${(Number(balance.aPNTs) / 1e18).toFixed(2)}</td>
                    </tr>
                `;
            }).join('');
        }

        // åŠ¨ä½œå‡½æ•°
        async function addNewAccount(type) {
            try {
                const response = await fetch(`${API_BASE}/add-account`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ type }) });
                if ((await response.json()).success) { await loadAccounts(); showToast(`âœ… ${type} è´¦æˆ·åˆ›å»ºæˆåŠŸï¼`); }
            } catch (e) { showToast('åˆ›å»ºè´¦æˆ·å¤±è´¥', 'error'); }
        }

        async function fundAllAccounts() {
            try {
                const btn = event.target; btn.disabled = true; btn.innerHTML = '<span class="loading"></span> å……å€¼ä¸­...';
                if ((await (await fetch(`${API_BASE}/fund-accounts`, { method: 'POST' })).json()).success) { await refreshBalances(); showToast('âœ… å……å€¼å®Œæˆï¼'); }
                btn.disabled = false; btn.textContent = 'ä¸ºæ‰€æœ‰è´¦æˆ·å……å€¼';
            } catch (e) { showToast('å……å€¼å¤±è´¥', 'error'); event.target.disabled = false; event.target.textContent = 'ä¸ºæ‰€æœ‰è´¦æˆ·å……å€¼'; }
        }

        async function launchCommunity() {
            const idx = document.getElementById('community-account-select').value;
            if (!idx) return showToast('è¯·é€‰æ‹©è´¦æˆ·', 'error');
            try {
                const btn = event.target; btn.disabled = true; btn.innerHTML = '<span class="loading"></span> å¯åŠ¨ä¸­...';
                const res = await (await fetch(`${API_BASE}/launch-community`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ accountIndex: parseInt(idx), name: document.getElementById('community-name').value }) })).json();
                if (res.success) { await loadCommunities(); showToast('âœ… ç¤¾åŒºå¯åŠ¨æˆåŠŸï¼'); await checkStatus('community'); }
                else showToast('å¯åŠ¨å¤±è´¥: ' + res.error, 'error');
                btn.disabled = false; btn.textContent = 'å¯åŠ¨ç¤¾åŒº';
            } catch (e) { showToast('å¯åŠ¨å¤±è´¥', 'error'); event.target.disabled = false; }
        }

        async function loadCommunities() {
            const listDiv = document.getElementById('communities-list');
            try {
                const res = await (await fetch(`${API_BASE}/get-communities`, { method: 'POST' })).json();
                if (res.success && res.communities.length > 0) {
                    listDiv.innerHTML = res.communities.map(c => {
                        const adminDisplay = `
                            <div class="code-box break-all text-xs" style="margin-top:2px;">
                                <a href="https://sepolia.etherscan.io/address/${c.accountAddress}" target="_blank" class="link-primary">
                                    ${c.accountAddress}
                                </a>
                                ${c.accountName && c.accountName !== 'Unknown Community' ? `<br/><span class="text-gray-500">(${c.accountName})</span>` : ''}
                            </div>
                        `;
                        
                        return `
                        <div class="list-card">
                            <div class="list-card-header">
                                <span class="list-card-title">ğŸ›ï¸ ${c.communityData?.name || 'Community'}</span>
                                <span class="badge ${c.hasRole ? 'badge-success' : 'badge-aa'}">${c.hasRole ? 'å·²æ¿€æ´»' : 'å¾…é…ç½®'}</span>
                            </div>
                            <div class="list-card-detail">
                                <span class="text-gray-600 font-bold">Operator (Admin):</span>
                                ${adminDisplay}
                            </div>
                            <div class="list-card-detail mt-2">Token: ${c.tokenAddress ? c.tokenAddress.slice(0, 10) + '...' : 'æœªéƒ¨ç½²'}</div>
                            <div class="list-card-detail" style="border-top: 1px dashed #eee; margin-top: 5px; padding-top: 5px;">
                                âš™ï¸ Paymaster Binding: None
                            </div>
                        </div>
                    `}).join('');
                } else listDiv.innerHTML = '<div style="text-align: center; opacity: 0.5;">æš‚æ— ç¤¾åŒº</div>';
            } catch (e) { listDiv.innerHTML = 'åŠ è½½å¤±è´¥'; }
        }

        async function setupOperator() {
            const idx = document.getElementById('operator-account-select').value;
            if (!idx) return showToast('è¯·é€‰æ‹©è´¦æˆ·', 'error');
            try {
                const btn = event.target; btn.disabled = true; btn.innerHTML = '<span class="loading"></span> è®¾ç½®ä¸­...';
                const res = await (await fetch(`${API_BASE}/setup-operator`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ accountIndex: parseInt(idx), type: selectedOperatorType }) })).json();
                if (res.success) { await loadOperators(); showToast('âœ… è¿è¥å•†è®¾ç½®æˆåŠŸï¼'); await checkStatus('operator'); }
                else showToast('è®¾ç½®å¤±è´¥: ' + res.error, 'error');
                btn.disabled = false; btn.textContent = 'å¼€å§‹è®¾ç½®';
            } catch (e) { showToast('è®¾ç½®å¤±è´¥', 'error'); event.target.disabled = false; }
        }

        async function loadOperators() {
            const listDiv = document.getElementById('operators-list');
            try {
                const res = await (await fetch(`${API_BASE}/get-operators`, { method: 'POST' })).json();
                if (res.success && res.operators.length > 0) {
                    listDiv.innerHTML = res.operators.map(o => `
                        <div class="list-card">
                            <div class="list-card-header">
                                <span class="list-card-title">âš™ï¸ ${o.accountName}</span>
                                <span class="badge badge-success">${o.type === 'super' ? 'SuperPaymaster' : 'V4'}</span>
                            </div>
                            <div class="list-card-detail">åœ°å€: ${o.accountAddress?.slice(0, 10)}...</div>
                            <div class="list-card-detail">ä½™é¢: ${(Number(o.superPaymaster?.balance || 0) / 1e18).toFixed(2)} aPNTs</div>
                        </div>
                    `).join('');
                } else listDiv.innerHTML = '<div style="text-align: center; opacity: 0.5;">æš‚æ— è¿è¥å•†</div>';
            } catch (e) { listDiv.innerHTML = 'åŠ è½½å¤±è´¥'; }
        }

        async function onboardUser() {
            const idx = document.getElementById('user-account-select').value;
            if (!idx) return showToast('è¯·é€‰æ‹©è´¦æˆ·', 'error');
            try {
                const btn = document.getElementById('onboard-btn');
                btn.disabled = true; btn.innerHTML = '<span class="loading"></span> å¤„ç†ä¸­...';
                const res = await (await fetch(`${API_BASE}/onboard-user`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ accountIndex: parseInt(idx) }) })).json();
                if (res.success) { showToast('âœ… å…¥é©»æˆåŠŸï¼SBT ID: ' + res.sbtId); await checkStatus('user'); }
                else showToast('å…¥é©»å¤±è´¥: ' + res.error, 'error');
                btn.disabled = false; btn.textContent = 'éƒ¨ç½² AA å¹¶ Mint SBT';
            } catch (e) { showToast('å¤±è´¥', 'error'); document.getElementById('onboard-btn').disabled = false; }
        }

        window.onload = async () => {
            await loadAccounts();
            await loadCommunities();
            await loadOperators();
        };
    </script>
</body>
</html>
